#!/usr/bin/env php
<?php

// 2024-08-29 jj5 - this script generates header files from the bitmap files.

require_once __DIR__ . '/inc/common.php';

function main( $argv ) {

  chdir( __DIR__ . '/../../' );

  foreach ( glob( 'bmp/*.bmp' ) as $path ) {

    process( $path );

  }
}

function process( $path ) {

  $filename = basename( $path, '.bmp' );

  $handle = fopen( $path, 'rb' );

  if ( ! $handle ) { die( "Failed to open file: $path\n" ); }

  $data = [];
  $count = 0;

  while ( ! feof( $handle ) ) {

    $string = fread( $handle, 1 );

    if ( strlen( $string ) === 0 ) { break; }

    if ( strlen( $string ) !== 1 ) { die( "Failed to read 1 byte\n" ); }

    $byte = $string[ 0 ];

    if ( $count++ < BMP_HEADER_LEN ) { continue; }

    $code = '0x' . bin2hex( $byte );

    $data[] = $code;

  }

  fclose( $handle );

  write_file( $filename, $data );

}

function write_file( $filename, $data ) {

  $code = "
// this bitmap header file was generated by bmp2hdr.php

const unsigned char {$filename}[] PROGMEM={64,64,
";

  $chunk_list = [];

  foreach ( array_chunk( $data, 8 ) as $chunk ) {

    $chunk_list[] = $chunk;

  }

  $chunk_list = array_reverse( $chunk_list );

  foreach ( $chunk_list as $chunk ) {

    $code .= implode( ',', $chunk ) . ",\n";

  }

  $code .= "};\n";

  file_put_contents( "ino/Symbol_Keyboard/gen/{$filename}.h", $code );

}

main( $argv );
